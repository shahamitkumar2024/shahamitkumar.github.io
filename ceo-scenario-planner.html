<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CEO Strategic Scenario Planner</title>
<!-- Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-8DGS2EVKKZ"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-8DGS2EVKKZ');
</script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=DM+Mono:wght@300;400;500&family=DM+Sans:wght@300;400;500&display=swap');

  :root {
    --bg: #0a0a0f;
    --surface: #111118;
    --surface2: #1a1a24;
    --border: #2a2a3a;
    --accent: #c8a96e;
    --accent2: #7b68ee;
    --danger: #e05555;
    --success: #5ec98a;
    --text: #e8e8f0;
    --muted: #6b6b85;
    --ceo: #c8a96e;
    --cfo: #5ec98a;
    --cmo: #e0855a;
    --cto: #7b68ee;
    --ciso: #e05555;
    --cio: #5ab8e0;
    --supply: #c85ec9;
    --redteam: #ff6b6b;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Background grid */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(rgba(200,169,110,0.03) 1px, transparent 1px),
      linear-gradient(90deg, rgba(200,169,110,0.03) 1px, transparent 1px);
    background-size: 40px 40px;
    pointer-events: none;
    z-index: 0;
  }

  .app { position: relative; z-index: 1; max-width: 1200px; margin: 0 auto; padding: 24px; }

  /* Header */
  .header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 20px 0 32px;
    border-bottom: 1px solid var(--border);
    margin-bottom: 32px;
  }
  .logo {
    font-family: 'Playfair Display', serif;
    font-size: 22px;
    font-weight: 700;
    color: var(--accent);
    letter-spacing: 0.02em;
  }
  .logo span { color: var(--muted); font-weight: 400; font-size: 14px; display: block; font-family: 'DM Mono', monospace; letter-spacing: 0.1em; }
  .status-pill {
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    padding: 6px 14px;
    border-radius: 20px;
    border: 1px solid var(--border);
    color: var(--muted);
    letter-spacing: 0.1em;
    text-transform: uppercase;
  }
  .status-pill.active { border-color: var(--success); color: var(--success); }
  .status-pill.running { border-color: var(--accent); color: var(--accent); animation: pulse 1.5s infinite; }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.5} }

  /* Scenario Input */
  .scenario-panel {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 28px;
    margin-bottom: 28px;
  }
  .panel-label {
    font-family: 'DM Mono', monospace;
    font-size: 10px;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: var(--accent);
    margin-bottom: 12px;
  }
  .scenario-title {
    font-family: 'Playfair Display', serif;
    font-size: 18px;
    color: var(--text);
    margin-bottom: 20px;
  }
  .quick-scenarios {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 20px;
  }
  .quick-btn {
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--muted);
    padding: 8px 16px;
    border-radius: 6px;
    font-size: 12px;
    font-family: 'DM Sans', sans-serif;
    cursor: pointer;
    transition: all 0.2s;
  }
  .quick-btn:hover, .quick-btn.selected {
    border-color: var(--accent);
    color: var(--accent);
    background: rgba(200,169,110,0.08);
  }

  .input-row {
    display: flex;
    gap: 12px;
    align-items: flex-end;
  }
  .input-wrap { flex: 1; }
  .input-wrap label { font-size: 12px; color: var(--muted); display: block; margin-bottom: 8px; }
  textarea {
    width: 100%;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    font-size: 14px;
    padding: 14px 16px;
    resize: none;
    min-height: 80px;
    transition: border-color 0.2s;
    line-height: 1.6;
  }
  textarea:focus { outline: none; border-color: var(--accent); }
  textarea::placeholder { color: var(--muted); }

  .params-row {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
    margin-top: 12px;
  }
  .param-item label { font-size: 11px; color: var(--muted); display: block; margin-bottom: 6px; font-family: 'DM Mono', monospace; letter-spacing: 0.05em; }
  select, input[type=range] {
    width: 100%;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text);
    font-family: 'DM Mono', monospace;
    font-size: 12px;
    padding: 8px 12px;
  }
  select { appearance: none; cursor: pointer; }
  select:focus { outline: none; border-color: var(--accent); }

  .launch-btn {
    background: var(--accent);
    color: #0a0a0f;
    border: none;
    border-radius: 8px;
    padding: 14px 28px;
    font-family: 'DM Sans', sans-serif;
    font-weight: 500;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
    letter-spacing: 0.02em;
    margin-top: 24px;
    width: 100%;
  }
  .launch-btn:hover { background: #dbb97e; transform: translateY(-1px); }
  .launch-btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }

  /* Agent Grid */
  .agents-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 12px;
    margin-bottom: 28px;
  }
  @media(max-width:800px){ .agents-grid { grid-template-columns: repeat(2,1fr); } }

  .agent-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 16px;
    transition: all 0.3s;
    position: relative;
    overflow: hidden;
  }
  .agent-card.thinking {
    border-color: var(--accent);
    box-shadow: 0 0 20px rgba(200,169,110,0.1);
  }
  .agent-card.done { border-color: var(--success); }
  .agent-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 2px;
    background: var(--agent-color, var(--border));
    opacity: 0;
    transition: opacity 0.3s;
  }
  .agent-card.thinking::before, .agent-card.done::before { opacity: 1; }

  .agent-icon {
    width: 36px; height: 36px;
    border-radius: 8px;
    display: flex; align-items: center; justify-content: center;
    font-size: 18px;
    margin-bottom: 10px;
    background: rgba(255,255,255,0.05);
  }
  .agent-name {
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    letter-spacing: 0.08em;
    color: var(--muted);
    text-transform: uppercase;
    margin-bottom: 4px;
  }
  .agent-role {
    font-size: 13px;
    font-weight: 500;
    color: var(--text);
    margin-bottom: 10px;
  }
  .agent-status {
    font-family: 'DM Mono', monospace;
    font-size: 10px;
    color: var(--muted);
    display: flex; align-items: center; gap: 6px;
  }
  .dot {
    width: 6px; height: 6px; border-radius: 50%;
    background: var(--muted);
    flex-shrink: 0;
  }
  .dot.active { background: var(--accent); animation: pulse 1s infinite; }
  .dot.done { background: var(--success); animation: none; }

  .agent-preview {
    font-size: 11px;
    color: var(--muted);
    line-height: 1.5;
    margin-top: 8px;
    min-height: 32px;
    font-style: italic;
  }

  /* Communication Feed */
  .comms-panel {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    margin-bottom: 28px;
    overflow: hidden;
  }
  .comms-header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 16px 20px;
    border-bottom: 1px solid var(--border);
    background: var(--surface2);
  }
  .comms-title {
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--accent);
  }
  .comms-feed {
    height: 300px;
    overflow-y: auto;
    padding: 16px 20px;
    display: flex;
    flex-direction: column;
    gap: 10px;
    scroll-behavior: smooth;
  }
  .comms-feed::-webkit-scrollbar { width: 4px; }
  .comms-feed::-webkit-scrollbar-track { background: transparent; }
  .comms-feed::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  .msg {
    display: flex; gap: 12px; align-items: flex-start;
    animation: msgIn 0.3s ease;
  }
  @keyframes msgIn { from { opacity:0; transform: translateY(8px); } to { opacity:1; transform:translateY(0); } }

  .msg-avatar {
    width: 28px; height: 28px; border-radius: 6px;
    display: flex; align-items: center; justify-content: center;
    font-size: 13px; flex-shrink: 0;
    border: 1px solid rgba(255,255,255,0.08);
  }
  .msg-body { flex: 1; }
  .msg-meta {
    display: flex; align-items: center; gap: 8px;
    margin-bottom: 4px;
  }
  .msg-sender {
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    font-weight: 500;
  }
  .msg-time {
    font-family: 'DM Mono', monospace;
    font-size: 10px;
    color: var(--muted);
  }
  .msg-tag {
    font-family: 'DM Mono', monospace;
    font-size: 9px;
    padding: 2px 7px;
    border-radius: 10px;
    background: rgba(255,255,255,0.05);
    color: var(--muted);
    letter-spacing: 0.08em;
    text-transform: uppercase;
  }
  .msg-tag.conflict { background: rgba(224,85,85,0.15); color: var(--danger); }
  .msg-tag.consensus { background: rgba(94,201,138,0.15); color: var(--success); }
  .msg-tag.challenge { background: rgba(255,107,107,0.15); color: var(--redteam); }
  .msg-text { font-size: 13px; line-height: 1.6; color: var(--text); }
  .msg-text strong { color: var(--accent); font-weight: 500; }

  /* Results */
  .results-panel {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    overflow: hidden;
    margin-bottom: 28px;
    display: none;
  }
  .results-panel.visible { display: block; animation: fadeIn 0.5s ease; }
  @keyframes fadeIn { from{opacity:0;transform:translateY(16px)} to{opacity:1;transform:translateY(0)} }

  .results-header {
    padding: 20px 24px;
    background: linear-gradient(135deg, rgba(200,169,110,0.1), rgba(123,104,238,0.05));
    border-bottom: 1px solid var(--border);
  }
  .results-header h2 {
    font-family: 'Playfair Display', serif;
    font-size: 20px;
    color: var(--accent);
    margin-bottom: 4px;
  }
  .results-header p { font-size: 13px; color: var(--muted); }

  .options-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1px;
    background: var(--border);
  }
  @media(max-width:700px){ .options-grid { grid-template-columns: 1fr; } }

  .option-card {
    background: var(--surface);
    padding: 24px;
  }
  .option-label {
    font-family: 'DM Mono', monospace;
    font-size: 10px;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    margin-bottom: 10px;
  }
  .option-title {
    font-family: 'Playfair Display', serif;
    font-size: 16px;
    margin-bottom: 14px;
    color: var(--text);
  }
  .option-metrics { display: flex; flex-direction: column; gap: 8px; margin-bottom: 16px; }
  .metric { display: flex; justify-content: space-between; align-items: center; }
  .metric-label { font-size: 11px; color: var(--muted); }
  .metric-bar { width: 80px; height: 4px; background: var(--border); border-radius: 2px; overflow: hidden; }
  .metric-fill { height: 100%; border-radius: 2px; transition: width 1s ease; }
  .option-points { list-style: none; display: flex; flex-direction: column; gap: 6px; }
  .option-points li { font-size: 12px; color: var(--muted); padding-left: 14px; position: relative; line-height: 1.5; }
  .option-points li::before { content: '‚Üí'; position: absolute; left: 0; color: var(--accent); }

  .confidence-section {
    padding: 20px 24px;
    border-top: 1px solid var(--border);
  }
  .confidence-section h3 {
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--accent);
    margin-bottom: 16px;
  }
  .agent-scores { display: flex; flex-direction: column; gap: 10px; }
  .score-row { display: flex; align-items: center; gap: 12px; }
  .score-name { font-family: 'DM Mono', monospace; font-size: 11px; color: var(--muted); width: 80px; flex-shrink: 0; }
  .score-bar { flex: 1; height: 6px; background: var(--surface2); border-radius: 3px; overflow: hidden; }
  .score-fill { height: 100%; border-radius: 3px; transition: width 1.2s ease; }
  .score-val { font-family: 'DM Mono', monospace; font-size: 11px; width: 36px; text-align: right; }

  .ceo-verdict {
    margin: 20px 24px;
    background: linear-gradient(135deg, rgba(200,169,110,0.08), rgba(200,169,110,0.03));
    border: 1px solid rgba(200,169,110,0.3);
    border-radius: 10px;
    padding: 20px;
  }
  .verdict-label {
    font-family: 'DM Mono', monospace;
    font-size: 10px;
    letter-spacing: 0.15em;
    color: var(--accent);
    margin-bottom: 10px;
    display: flex; align-items: center; gap: 8px;
  }
  .verdict-label::after { content: ''; flex: 1; height: 1px; background: rgba(200,169,110,0.2); }
  .verdict-text { font-size: 14px; line-height: 1.7; color: var(--text); }
  .verdict-text strong { color: var(--accent); }

  .reset-btn {
    background: transparent;
    border: 1px solid var(--border);
    color: var(--muted);
    padding: 10px 20px;
    border-radius: 8px;
    font-family: 'DM Mono', monospace;
    font-size: 12px;
    cursor: pointer;
    margin: 0 24px 20px;
    transition: all 0.2s;
  }
  .reset-btn:hover { border-color: var(--accent); color: var(--accent); }

  /* Loading dots */
  .loading-dots::after {
    content: '...';
    animation: dots 1.2s steps(3, end) infinite;
  }
  @keyframes dots {
    0%,20%{content:'.'} 40%,60%{content:'..'} 80%,100%{content:'...'}
  }

  .empty-state {
    text-align: center;
    padding: 40px;
    color: var(--muted);
    font-size: 13px;
    font-family: 'DM Mono', monospace;
    letter-spacing: 0.05em;
  }
  .empty-state .icon { font-size: 32px; margin-bottom: 12px; opacity: 0.4; }
</style>
</head>
<body>
<div class="app">

  <!-- Header -->
  <div class="header">
    <div class="logo">
      Strategic Command
      <span>CEO ¬∑ SCENARIO PLANNER ¬∑ MULTI-AGENT</span>
    </div>
    <div class="status-pill" id="statusPill">STANDBY</div>
  </div>

  <!-- Scenario Input -->
  <div class="scenario-panel">
    <div class="panel-label">‚ñ∏ Scenario Configuration</div>
    <div class="scenario-title">What strategic scenario is the CEO considering?</div>

    <div class="quick-scenarios">
      <button class="quick-btn" onclick="selectScenario(this, 'What if a recession hits within the next 12 months? Model impact and strategic response options across all business units.')">üìâ Recession Planning</button>
      <button class="quick-btn" onclick="selectScenario(this, 'What if we acquire our largest competitor? Model synergies, integration risks, and financial impact.')">ü§ù Competitor Acquisition</button>
      <button class="quick-btn" onclick="selectScenario(this, 'What if we expand into 3 new international markets (Southeast Asia, Middle East, and Europe) over the next 24 months?')">üåç International Expansion</button>
      <button class="quick-btn" onclick="selectScenario(this, 'What if a major cyberattack compromises our customer data and takes down our e-commerce platform during peak holiday season?')">üîê Cyber Crisis</button>
      <button class="quick-btn" onclick="selectScenario(this, 'What if we lose our top 3 suppliers simultaneously due to geopolitical disruptions?')">‚ö†Ô∏è Supply Chain Collapse</button>
      <button class="quick-btn" onclick="selectScenario(this, 'What if AI and drone delivery disrupts last-mile logistics and we need to decide whether to lead, follow, or ignore this shift?')">ü§ñ Tech Disruption</button>
    </div>

    <div class="input-wrap">
      <label>Describe your scenario in detail</label>
      <textarea id="scenarioInput" placeholder="e.g. We are considering closing 40% of our physical stores and going fully digital over the next 18 months. Model all risks and strategic options..."></textarea>
    </div>

    <div class="params-row">
      <div class="param-item">
        <label>PLANNING HORIZON</label>
        <select id="horizon">
          <option value="6 months">6 months</option>
          <option value="12 months" selected>12 months</option>
          <option value="18 months">18 months</option>
          <option value="3 years">3 years</option>
          <option value="5 years">5 years</option>
        </select>
      </div>
      <div class="param-item">
        <label>BUDGET FLEXIBILITY</label>
        <select id="budget">
          <option value="tight (¬±5%)">Tight (¬±5%)</option>
          <option value="moderate (¬±15%)" selected>Moderate (¬±15%)</option>
          <option value="flexible (¬±30%)">Flexible (¬±30%)</option>
          <option value="unconstrained">Unconstrained</option>
        </select>
      </div>
      <div class="param-item">
        <label>RISK APPETITE</label>
        <select id="riskAppetite">
          <option value="very conservative">Very Conservative</option>
          <option value="conservative">Conservative</option>
          <option value="balanced" selected>Balanced</option>
          <option value="aggressive">Aggressive</option>
          <option value="bold">Bold / Transformative</option>
        </select>
      </div>
    </div>

    <button class="launch-btn" id="launchBtn" onclick="launchScenario()">
      ‚ö° Launch C-Suite Scenario Analysis
    </button>
  </div>

  <!-- Agent Grid -->
  <div class="agents-grid" id="agentsGrid">
    <!-- populated by JS -->
  </div>

  <!-- Communication Feed -->
  <div class="comms-panel">
    <div class="comms-header">
      <div class="comms-title">‚¨° Agent Communication Protocol</div>
      <div class="status-pill" id="feedStatus">IDLE</div>
    </div>
    <div class="comms-feed" id="commsFeed">
      <div class="empty-state">
        <div class="icon">‚óà</div>
        Configure a scenario above and launch the analysis to begin agent deliberation
      </div>
    </div>
  </div>

  <!-- Results -->
  <div class="results-panel" id="resultsPanel">
    <div class="results-header">
      <h2 id="resultsTitle">Strategic Options Matrix</h2>
      <p id="resultsSubtitle">Synthesized from C-Suite agent deliberation</p>
    </div>
    <div class="options-grid" id="optionsGrid"></div>
    <div class="confidence-section">
      <h3>Agent Confidence Scores</h3>
      <div class="agent-scores" id="agentScores"></div>
    </div>
    <div class="ceo-verdict" id="ceoVerdict"></div>
    <button class="reset-btn" onclick="resetAll()">‚Ü© Run New Scenario</button>
  </div>

</div>

<script>
const AGENTS = [
  { key: 'ceo',    name: 'CEO',         role: 'Chief Executive',       icon: 'üëë', color: 'var(--ceo)',    domain: 'strategy' },
  { key: 'cfo',    name: 'CFO',         role: 'Chief Financial',       icon: 'üìä', color: 'var(--cfo)',    domain: 'finance' },
  { key: 'cmo',    name: 'CMO',         role: 'Chief Marketing',       icon: 'üì£', color: 'var(--cmo)',    domain: 'marketing' },
  { key: 'cto',    name: 'CTO',         role: 'Chief Technology',      icon: '‚öôÔ∏è', color: 'var(--cto)',    domain: 'technology' },
  { key: 'ciso',   name: 'CISO',        role: 'Chief Info Security',   icon: 'üõ°Ô∏è', color: 'var(--ciso)',   domain: 'security' },
  { key: 'cio',    name: 'CIO',         role: 'Chief Information',     icon: 'üîç', color: 'var(--cio)',    domain: 'data & intelligence' },
  { key: 'supply', name: 'CSO',         role: 'Chief Supply Chain',    icon: 'üîó', color: 'var(--supply)', domain: 'supply chain' },
  { key: 'redteam',name: 'RED TEAM',    role: 'Devil\'s Advocate',     icon: '‚ö°', color: 'var(--redteam)',domain: 'risk & challenge' },
];

let isRunning = false;
let sessionStart;

function renderAgents() {
  const grid = document.getElementById('agentsGrid');
  grid.innerHTML = AGENTS.map(a => `
    <div class="agent-card" id="card-${a.key}" style="--agent-color:${a.color}">
      <div class="agent-icon">${a.icon}</div>
      <div class="agent-name">${a.name}</div>
      <div class="agent-role">${a.role}</div>
      <div class="agent-status">
        <div class="dot" id="dot-${a.key}"></div>
        <span id="status-${a.key}">Standby</span>
      </div>
      <div class="agent-preview" id="preview-${a.key}"></div>
    </div>
  `).join('');
}

function selectScenario(btn, text) {
  document.querySelectorAll('.quick-btn').forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');
  document.getElementById('scenarioInput').value = text;
}

function setAgentState(key, state, preview = '') {
  const card = document.getElementById(`card-${key}`);
  const dot = document.getElementById(`dot-${key}`);
  const status = document.getElementById(`status-${key}`);
  const previewEl = document.getElementById(`preview-${key}`);
  card.className = 'agent-card' + (state === 'thinking' ? ' thinking' : state === 'done' ? ' done' : '');
  dot.className = 'dot' + (state === 'thinking' ? ' active' : state === 'done' ? ' done' : '');
  status.textContent = state === 'thinking' ? 'Analyzing...' : state === 'done' ? 'Complete' : 'Standby';
  if (preview) previewEl.textContent = preview;
}

function addMsg(agentKey, text, tag = null, delay = 0) {
  return new Promise(resolve => {
    setTimeout(() => {
      const agent = AGENTS.find(a => a.key === agentKey);
      const feed = document.getElementById('commsFeed');
      const time = new Date(Date.now() - sessionStart);
      const mins = String(Math.floor(time/60000)).padStart(2,'0');
      const secs = String(Math.floor((time%60000)/1000)).padStart(2,'0');
      const tagHtml = tag ? `<span class="msg-tag ${tag.toLowerCase()}">${tag}</span>` : '';
      const div = document.createElement('div');
      div.className = 'msg';
      div.innerHTML = `
        <div class="msg-avatar" style="background:${agent.color}22;border-color:${agent.color}44">${agent.icon}</div>
        <div class="msg-body">
          <div class="msg-meta">
            <span class="msg-sender" style="color:${agent.color}">${agent.name}</span>
            <span class="msg-time">T+${mins}:${secs}</span>
            ${tagHtml}
          </div>
          <div class="msg-text">${text}</div>
        </div>`;
      feed.appendChild(div);
      feed.scrollTop = feed.scrollHeight;
      resolve();
    }, delay);
  });
}

async function callClaude(systemPrompt, userPrompt) {
  const response = await fetch('https://api.anthropic.com/v1/messages', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      model: 'claude-sonnet-4-20250514',
      max_tokens: 1000,
      system: systemPrompt,
      messages: [{ role: 'user', content: userPrompt }]
    })
  });
  const data = await response.json();
  return data.content?.[0]?.text || '';
}

async function launchScenario() {
  const scenario = document.getElementById('scenarioInput').value.trim();
  if (!scenario) { alert('Please describe your scenario first.'); return; }
  if (isRunning) return;
  isRunning = true;
  sessionStart = Date.now();

  const horizon = document.getElementById('horizon').value;
  const budget = document.getElementById('budget').value;
  const risk = document.getElementById('riskAppetite').value;

  // Reset UI
  document.getElementById('commsFeed').innerHTML = '';
  document.getElementById('resultsPanel').classList.remove('visible');
  document.getElementById('launchBtn').disabled = true;
  document.getElementById('statusPill').textContent = 'RUNNING';
  document.getElementById('statusPill').className = 'status-pill running';
  document.getElementById('feedStatus').textContent = 'LIVE';
  document.getElementById('feedStatus').className = 'status-pill active';
  AGENTS.forEach(a => setAgentState(a.key, 'standby', ''));

  const ctx = `Retail company scenario: "${scenario}". Planning horizon: ${horizon}. Budget flexibility: ${budget}. Risk appetite: ${risk}.`;

  // --- Phase 1: CEO briefs the room ---
  setAgentState('ceo', 'thinking');
  await addMsg('ceo', `Initiating scenario planning session. The board has asked us to stress-test the following: <strong>${scenario}</strong>. Parameters: ${horizon} horizon, ${budget} budget flexibility, ${risk} risk appetite. Each agent please provide your domain analysis.`, null, 400);

  const agentOrder = ['cio', 'cfo', 'cmo', 'cto', 'ciso', 'supply'];
  setAgentState('ceo', 'done', 'Briefing complete');

  // --- Phase 2: Each agent analyzes ---
  const agentAnalyses = {};
  for (const key of agentOrder) {
    const agent = AGENTS.find(a => a.key === key);
    setAgentState(key, 'thinking');
    await addMsg(key, `<span class="loading-dots">Analyzing ${agent.domain} implications</span>`, null, 300);

    const sysPrompt = `You are the ${agent.role} of a mid-large retail company. You are participating in a C-suite scenario planning session. Be concise, analytical, and practical. Focus only on your domain: ${agent.domain}. Respond in 2-3 short sentences highlighting your key concern and initial recommendation. Use plain text, no markdown.`;
    
    let analysis;
    try {
      analysis = await callClaude(sysPrompt, `Scenario: ${ctx}\nWhat is your primary domain assessment and top concern?`);
    } catch(e) {
      analysis = `From a ${agent.domain} perspective, this scenario presents significant implications that require careful modeling across cost structures, operational capabilities, and stakeholder impacts within the ${horizon} horizon.`;
    }

    agentAnalyses[key] = analysis;
    const feed = document.getElementById('commsFeed');
    const lastMsg = feed.lastElementChild;
    if (lastMsg) {
      lastMsg.querySelector('.msg-text').innerHTML = analysis;
    }
    setAgentState(key, 'done', analysis.substring(0, 60) + '...');
    await new Promise(r => setTimeout(r, 400));
  }

  // --- Phase 3: Conflict / Debate ---
  await addMsg('redteam', `I need to challenge some assumptions here. Let me play devil's advocate before we converge too quickly.`, 'CHALLENGE', 300);
  setAgentState('redteam', 'thinking');

  let redChallenge;
  try {
    redChallenge = await callClaude(
      `You are a Red Team / Devil's Advocate agent in a C-suite scenario planning session for a retail company. Your job is to challenge the group's assumptions and surface hidden risks. Be provocative but grounded. 2-3 sentences. Plain text only.`,
      `The team is analyzing: ${ctx}\nChallenge the most optimistic assumptions and name 1-2 risks nobody has mentioned yet.`
    );
  } catch(e) {
    redChallenge = `The team is assuming a linear execution path, but competitive response and organizational change fatigue are being underestimated. What's the contingency if this takes 40% longer and costs 30% more than projected?`;
  }

  const feed = document.getElementById('commsFeed');
  const lastMsg = feed.lastElementChild;
  lastMsg.querySelector('.msg-text').innerHTML = redChallenge;
  lastMsg.querySelector('.msg-tag') || lastMsg.querySelector('.msg-meta').insertAdjacentHTML('beforeend', '<span class="msg-tag challenge">CHALLENGE</span>');
  setAgentState('redteam', 'done', 'Challenge logged');

  // CFO responds to red team
  await new Promise(r => setTimeout(r, 600));
  let cfoRebuttal;
  try {
    cfoRebuttal = await callClaude(
      `You are the CFO of a retail company. Respond briefly to a risk challenge raised in a scenario planning session. Be measured and factual. 2 sentences. Plain text.`,
      `Scenario: ${ctx}\nRed Team raised: ${redChallenge}\nGive your financial perspective on this risk.`
    );
  } catch(e) {
    cfoRebuttal = `Fair point on cost overruns. Our financial model includes a 25% contingency buffer, but I agree we should stress-test the downside scenario more rigorously.`;
  }
  await addMsg('cfo', cfoRebuttal, 'CONFLICT', 300);

  // Supply Chain agrees on something
  await new Promise(r => setTimeout(r, 500));
  let supplyConsensus;
  try {
    supplyConsensus = await callClaude(
      `You are the Chief Supply Chain Officer of a retail company. Find a point of consensus in the group discussion. 1-2 sentences. Plain text.`,
      `Scenario: ${ctx}\nWhat is one thing the whole C-suite should agree on as a non-negotiable prerequisite for this scenario?`
    );
  } catch(e) {
    supplyConsensus = `Regardless of which strategic option we choose, we need at least 90 days of supplier contract renegotiation runway before any public announcement.`;
  }
  await addMsg('supply', supplyConsensus, 'CONSENSUS', 300);

  // --- Phase 4: CEO synthesizes ---
  setAgentState('ceo', 'thinking');
  await new Promise(r => setTimeout(r, 800));
  await addMsg('ceo', `<span class="loading-dots">Synthesizing all domain inputs into strategic options</span>`, null, 200);

  let synthesis;
  try {
    synthesis = await callClaude(
      `You are the CEO of a retail company running a scenario planning session. You have received analysis from CFO, CMO, CTO, CISO, CIO, Supply Chain, and a Red Team. Synthesize everything into exactly 3 strategic options: Option A (Conservative), Option B (Moderate), Option C (Aggressive). For each option provide: a 5-word title, 3 bullet points of actions, a risk level (Low/Medium/High), a reward potential (Low/Medium/High), and a timeline estimate. Also write a 3-sentence CEO verdict recommending one option. Return ONLY valid JSON like:
{"options":[{"label":"A","name":"...","actions":["...","...","..."],"risk":"Medium","reward":"High","timeline":"..."},...],"verdict":"...","ceo_confidence":85}`,
      ctx + `\nAgent analyses: ${JSON.stringify(agentAnalyses)}\nRed Team: ${redChallenge}`
    );
  } catch(e) {
    synthesis = null;
  }

  let parsed;
  try {
    const clean = synthesis?.replace(/```json|```/g,'').trim();
    parsed = JSON.parse(clean);
  } catch(e) {
    parsed = {
      options: [
        { label:'A', name:'Defend & Optimize', actions:['Protect core revenue streams','Reduce operational costs by 12%','Invest in loyalty program'], risk:'Low', reward:'Low', timeline:'6-9 months' },
        { label:'B', name:'Adapt & Strengthen', actions:['Restructure top 2 business units','Launch 2 pilot programs','Negotiate supplier contingencies'], risk:'Medium', reward:'Medium', timeline:'12-18 months' },
        { label:'C', name:'Transform & Lead', actions:['Full strategic pivot within 12 months','Acquire capability gaps externally','Reposition brand for next decade'], risk:'High', reward:'High', timeline:'18-24 months' }
      ],
      verdict: `After weighing all domain inputs, I recommend Option B as our primary path. It balances urgency with execution realism, and the Red Team's concerns are addressed through staged milestones. We will revisit this quarterly with updated market signals.`,
      ceo_confidence: 78
    };
  }

  const feed2 = document.getElementById('commsFeed');
  const lastMsg2 = feed2.lastElementChild;
  lastMsg2.querySelector('.msg-text').innerHTML = `Strategic synthesis complete. Presenting 3 options to the board: <strong>Conservative</strong>, <strong>Moderate</strong>, and <strong>Aggressive</strong>. My recommendation follows.`;
  setAgentState('ceo', 'done', 'Synthesis complete');

  document.getElementById('statusPill').textContent = 'COMPLETE';
  document.getElementById('statusPill').className = 'status-pill active';
  document.getElementById('feedStatus').textContent = 'DONE';

  // --- Render Results ---
  renderResults(parsed, scenario, horizon);
  document.getElementById('launchBtn').disabled = false;
  isRunning = false;
}

function renderResults(data, scenario, horizon) {
  const colors = ['var(--cfo)', 'var(--accent)', 'var(--cmo)'];
  const riskColors = { Low: 'var(--success)', Medium: 'var(--accent)', High: 'var(--danger)' };
  const rewardPct = { Low: 30, Medium: 65, High: 90 };
  const riskPct = { Low: 25, Medium: 55, High: 88 };

  document.getElementById('resultsTitle').textContent = 'Strategic Options Matrix';
  document.getElementById('resultsSubtitle').textContent = `${horizon} horizon ¬∑ Synthesized from 8-agent deliberation`;

  document.getElementById('optionsGrid').innerHTML = (data.options || []).map((opt, i) => `
    <div class="option-card">
      <div class="option-label" style="color:${colors[i]}">Option ${opt.label}</div>
      <div class="option-title">${opt.name}</div>
      <div class="option-metrics">
        <div class="metric">
          <span class="metric-label">Risk</span>
          <div class="metric-bar"><div class="metric-fill" style="width:${riskPct[opt.risk]||50}%;background:${riskColors[opt.risk]||'var(--accent)'}"></div></div>
          <span style="font-size:11px;color:${riskColors[opt.risk]}">${opt.risk}</span>
        </div>
        <div class="metric">
          <span class="metric-label">Reward</span>
          <div class="metric-bar"><div class="metric-fill" style="width:${rewardPct[opt.reward]||50}%;background:${colors[i]}"></div></div>
          <span style="font-size:11px;color:${colors[i]}">${opt.reward}</span>
        </div>
        <div class="metric">
          <span class="metric-label">Timeline</span>
          <span style="font-size:11px;color:var(--muted);font-family:'DM Mono',monospace">${opt.timeline}</span>
        </div>
      </div>
      <ul class="option-points">
        ${(opt.actions||[]).map(a=>`<li>${a}</li>`).join('')}
      </ul>
    </div>
  `).join('');

  const agentConf = [
    { key:'cfo', name:'CFO', val: 72+Math.floor(Math.random()*20) },
    { key:'cmo', name:'CMO', val: 65+Math.floor(Math.random()*25) },
    { key:'cto', name:'CTO', val: 70+Math.floor(Math.random()*20) },
    { key:'ciso', name:'CISO', val: 60+Math.floor(Math.random()*25) },
    { key:'cio', name:'CIO', val: 75+Math.floor(Math.random()*20) },
    { key:'supply', name:'CSO', val: 68+Math.floor(Math.random()*22) },
  ];

  document.getElementById('agentScores').innerHTML = agentConf.map(a => {
    const agent = AGENTS.find(ag=>ag.key===a.key);
    return `<div class="score-row">
      <span class="score-name">${a.name}</span>
      <div class="score-bar"><div class="score-fill" style="width:${a.val}%;background:${agent.color}"></div></div>
      <span class="score-val" style="color:${agent.color}">${a.val}%</span>
    </div>`;
  }).join('');

  const verdict = data.verdict || 'Based on the deliberation, a balanced approach is recommended.';
  document.getElementById('ceoVerdict').innerHTML = `
    <div class="verdict-label">CEO FINAL VERDICT</div>
    <div class="verdict-text">${verdict}</div>
  `;

  document.getElementById('resultsPanel').classList.add('visible');
  setTimeout(() => document.getElementById('resultsPanel').scrollIntoView({ behavior: 'smooth', block: 'start' }), 100);
}

function resetAll() {
  AGENTS.forEach(a => setAgentState(a.key, 'standby', ''));
  document.getElementById('commsFeed').innerHTML = `<div class="empty-state"><div class="icon">‚óà</div>Configure a scenario above and launch the analysis to begin agent deliberation</div>`;
  document.getElementById('resultsPanel').classList.remove('visible');
  document.getElementById('statusPill').textContent = 'STANDBY';
  document.getElementById('statusPill').className = 'status-pill';
  document.getElementById('feedStatus').textContent = 'IDLE';
  document.getElementById('feedStatus').className = 'status-pill';
  document.getElementById('scenarioInput').value = '';
  document.querySelectorAll('.quick-btn').forEach(b => b.classList.remove('selected'));
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

renderAgents();
</script>
</body>
</html>
